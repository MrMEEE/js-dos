<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="built-on" content="2024-06-14T21:29:30.737869"><title>Node | js-dos</title><script type="application/json" id="virtual-toc-data">[]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b267/app.css" rel="stylesheet"><link rel="icon" type="image/png" sizes="16x16" href="images/logo-16.png"><link rel="icon" type="image/png" sizes="32x32" href="images/logo-32.png"><link rel="icon" type="image/png" sizes="96x96" href="images/logo-192.png"><link rel="icon" type="image/png" sizes="300x300" href="images/logo-512.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Node | js-dos"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="js-dos Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://js-dos.com//8.xx/node.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Node | js-dos"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "https://js-dos.com//8.xx/node.html#webpage",
    "url": "https://js-dos.com//8.xx/node.html",
    "name": "Node | js-dos",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "https://js-dos.com/#website",
    "url": "https://js-dos.com/",
    "name": "js-dos Help"
}</script><!-- End Schema.org --></head><body data-id="Node" data-main-title="Node" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="emulators.md|emulators///threejs.md|How-to use"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>js-dos 8.xx Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Node" id="Node.md">Node</h1><p id="wgforw_2">In this tutorial we will run Digger game in Node.js and save game screenshot to the image.</p><p id="wgforw_3">Let's start with creating empty project:</p><div class="code-block" data-lang="bash">
npm init
</div><p id="wgforw_5">To run DOS in browser we need to install <a href="https://www.npmjs.com/package/emulators" id="wgforw_6" data-external="true" rel="noopener noreferrer">emulators</a> package. For creating screenshot we will use <code class="code" id="wgforw_7">jimp</code> library. So let's install them.</p><div class="code-block" data-lang="bash">
npm install --save emulators jimp
</div><p id="wgforw_9">Next we need to download Digger <a href="jsdos-bundle.html" id="wgforw_10" data-tooltip="Starting from js-dos v7, the API expects a js-dos bundle that already contains all configuration needed to start the DOS program. js-dos bundle is just a ZIP archive that contains the game itself and a js-dos configuration file (same as dosbox.conf file). For example, digger.jsdos…">js-dos bundle</a>:</p><div class="code-block" data-lang="bash">
curl https://cdn.dos.zone/original/2X/2/24b00b14f118580763440ecaddcc948f8cb94f14.jsdos -o digger.jsdos
</div><p id="wgforw_12">Let's create source file <code class="code" id="wgforw_13">digger.js</code>. We can run it with this command <code class="code" id="wgforw_14">node digger.js</code></p><p id="wgforw_15"><span class="control" id="wgforw_16">Use require to import all libraries</span></p><div class="code-block" data-lang="javascript">
const fs = require(&quot;fs&quot;);
const jimp = require(&quot;jimp&quot;);

require(&quot;emulators&quot;);

const emulators = global.emulators;
emulators.pathPrefix = &quot;./&quot;;
</div><br><aside class="prompt" data-type="tip" data-title="" id="wgforw_19"><p id="wgforw_20">emulators package does not use export system. It injects itself into global object. <code class="code" id="wgforw_21">pathPrefix</code> is used to locate wasm files it relative to <code class="code" id="wgforw_22">require</code> path.</p></aside><p id="wgforw_23"><span class="control" id="wgforw_24">Now we need to read contents of <code class="code" id="wgforw_25">jsdos bundle</code> and start emulation</span></p><div class="code-block" data-lang="javascript">
const bundle = fs.readFileSync(&quot;digger.jsdos&quot;);

emulators
    .dosDirect(bundle)
    .then((ci) =&gt; {
      // ...
    });
</div><p id="wgforw_27">When dos emulation starts, we will receive <a href="command-interface.html" id="wgforw_28" data-tooltip="The Command Interface is only one object that allows you to communicate with js-dos instance. Once you run some js-dos bundle you will receive Command Interface instance.">Command Interface</a>, we can use it to subscribe on frame updates and to send key/mouse events.</p><div class="code-block" data-lang="javascript">
    ci.events().onFrame((rgb, rgba) =&gt; {
        // use rgb or rgba image data
    });
</div><aside class="prompt" data-type="warning" data-title="" id="wgforw_30"><p id="wgforw_31"><span class="control" id="wgforw_32">onFrame</span> method have two arguments <code class="code" id="wgforw_33">rgb</code> and <code class="code" id="wgforw_34">rgba</code> image data. One of them is always <span class="control" id="wgforw_35">null</span> while other is <span class="control" id="wgforw_36">UInt8ClampedArray</span>. It depends on used emulator which data it uses rgb or rgba.</p></aside><p id="wgforw_37">In the v7 we have frame in RGBA format with transparent alpha, let's fix this and save screenshot:</p><div class="code-block" data-lang="javascript">
    const width = ci.width();
    const height = ci.height();
    
    for (let next = 3; next &lt; width * height * 4; next = next + 4) {
        rgba[next] = 255;
    }

    new jimp({ data: rgba, width, height }, (err, image) =&gt; {
        image.write(&quot;./screenshot.png&quot;, () =&gt; {
            ci.exit();
        });
    });
</div><br><p id="wgforw_40">If you execute <code class="code" id="wgforw_41">node digger.js</code> it will save the screenshot to <code class="code" id="wgforw_42">./screenshot.png</code>.</p><p id="wgforw_43">Full code of <code class="code" id="wgforw_44">digger.js</code>:</p><div class="code-block" data-lang="javascript">
const fs = require(&quot;fs&quot;);
const jimp = require(&quot;jimp&quot;);

require(&quot;emulators&quot;);

const emulators = global.emulators;
emulators.pathPrefix = &quot;./&quot;;

const bundle = fs.readFileSync(&quot;digger.jsdos&quot;);

emulators
    .dosDirect(bundle)
    .then((ci) =&gt; {
        let rgba = new Uint8Array(0);
        ci.events().onFrame((_, _rgba) =&gt; {
            rgba = _rgba;
        });

        // capture the screen after 3 sec
        console.log(&quot;Will capture screen after 3 sec...&quot;);
        setTimeout(() =&gt; {
            const width = ci.width();
            const height = ci.height();

            for (let next = 3; next &lt; width * height * 4; next = next + 4) {
                rgba[next] = 255;
            }           

            new jimp({ data: rgba, width, height }, (err, image) =&gt; {
                image.write(&quot;./screenshot.png&quot;, () =&gt; {
                    ci.exit();
                });
            });
        }, 3000);
    })
    .catch(console.error);
</div><div class="last-modified">Last modified: 14 июня 2024</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="browser.html" class="navigation-links__prev">Browser</a><a href="save-load.html" class="navigation-links__next">Persist FS</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b267/app.js"></script></body></html>